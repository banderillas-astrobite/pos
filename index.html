<!doctype html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1.0,user-scalable=no,shrink-to-fit=no" />
    <title>Astro Bite TPV Multi-Ticket (Final)</title>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>

    <style>
        :root{
            /* Colores */
            --brand: #ff6b00;
            --brand-dark: #d95000;
            --accent: #ff9f43;
            --muted: #f3f4f6;
            --card: #ffffff;
            --text: #222;
            --success: #2ecc71;
            --danger: #e74c3c;
            --shadow: 0 10px 30px rgba(0,0,0,0.12);
            --radius: 12px;
            --gap: 12px;
            --max-width: 980px;
        
            /* Colores para identificación rápida del relleno */
            --color-salchicha: #ffecb3; 
            --color-combinada: #b3e5fc; 
            --color-queso: #c8e6c9; 
            --color-extra: #f0f0f0; 
            
            /* Colores de Tickets Activos */
            --ticket-bg: #f9f9f9;
            --ticket-active-bg: #fff;
            --ticket-border: #eee;
            --highlight-cash: #fffbe6; /* Amarillo suave para resaltar el pago */
        }

        *{box-sizing:border-box}
        html,body{height:100%}
        body{
            margin:0;
            font-family: Inter, "Helvetica Neue", Arial, sans-serif;
            background:#fff;
            color:var(--text);
            display:flex;
            justify-content:center;
            padding:1rem;
            touch-action: manipulation;
        }

        .wrap{
            width:100%;
            max-width:var(--max-width);
            display:grid;
            grid-template-columns:1fr 380px;
            gap:1rem;
            align-items:start;
        }

        /* --- CSS Base de Elementos --- */
        header.app-header{
            grid-column:1 / -1;
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:1rem;
            margin-bottom:0.5rem;
        }
        .brand{
            display:flex;
            align-items:center;
            gap:0.8rem;
        }
        .logo{
            width:44px;
            height:44px;
            border-radius:10px;
            background:linear-gradient(135deg,var(--brand),var(--accent));
            display:flex;
            align-items:center;
            justify-content:center;
            color:white;
            font-weight:700;
            box-shadow: var(--shadow);
        }
        h1{font-size:1.1rem;margin:0}
        .sub{color:#666;font-size:0.85rem;margin:0}
        .panel{
            background:var(--card);
            border-radius: var(--radius);
            padding: 1rem;
            box-shadow: var(--shadow);
        }

        /* Contenedor de la sección de productos para DESKTOP */
        #product-panel-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        /* Categorías */
        .categories{
            display:flex;
            gap:var(--gap);
            margin-bottom:0.75rem;
            overflow-x:auto; 
            padding-bottom: 5px; 
            order: 0; 
        }
        .cat-btn{
            white-space:nowrap;
            padding:0.5rem 0.75rem;
            border-radius:999px;
            border:1px solid transparent;
            background:var(--muted);
            color: #333;
            font-weight:600;
            cursor:pointer;
            flex:0 0 auto;
        }
        .cat-btn.active{background:var(--brand); color:white; border-color:var(--brand-dark)}

        /* Productos (Diseño de 2 columnas por defecto para DESKTOP) */
        .product-grid{
            display:grid;
            grid-template-columns: repeat(2, 1fr);
            gap:0; 
            border: 1px solid #eee; /* Borde externo de la cuadrícula de productos */
            border-radius: 8px;
            overflow: hidden;
            order: 1; 
        }
        .prod{
            background:white;
            padding:0.6rem;
            display:flex;
            flex-direction:column;
            justify-content:space-between;
            min-height:50px;
            border-right: 1px solid #eee;
            border-bottom: 1px solid #eee;
            cursor:pointer;
            transition:background .12s ease;
        }
        .prod:nth-child(2n){ border-right: none; }
        .prod:hover{ background:var(--muted); }
        .prod .name{font-weight:700;font-size:0.95rem;margin-bottom:0.15rem}
        .prod .price{color:var(--brand-dark); font-weight:800}
        
        .extras{ order: 2; }
        
        /* Tickets Activos (Ajustes de márgenes y padding en los totales) */
        .ticket {
            background: var(--ticket-active-bg);
            border-radius: 0 0 var(--radius) var(--radius); 
            padding:1rem;
            box-shadow: var(--shadow);
            margin-top: -1px; 
        }
        
        /* REFUERZO DE ESTILOS DE PESTAÑAS (CLIENTES) */
        .ticket-tabs {
            display: flex;
            gap: 4px;
            overflow-x: auto;
            padding-bottom: 8px; 
        }
        .ticket-tab {
            flex: 0 0 auto;
            padding: 0.5rem 0.8rem;
            border-radius: var(--radius) var(--radius) 0 0;
            border: 1px solid var(--ticket-border);
            border-bottom: none;
            background: var(--ticket-bg);
            color: #555;
            font-weight: 600;
            cursor:pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background .15s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-left: 5px solid rgba(0,0,0,0.1); 
        }
        .ticket-tab.active {
            background: var(--ticket-active-bg);
            color: var(--text);
            border-color: var(--brand);
            border-bottom: 1px solid var(--ticket-active-bg); 
            z-index: 10;
        }
        .close-tab { 
            background: none; 
            border: none; 
            color: #777; 
            font-weight: 700; 
            cursor: pointer; 
            padding: 0; 
            line-height: 1;
        }
        .new-ticket-btn {
            background: var(--success); 
            color: white;
            border-radius: var(--radius) var(--radius) 0 0; 
            width: 38px;
            padding: 0.4rem 0;
            font-size: 1rem;
            border: none;
            cursor: pointer;
            font-weight: 700;
            flex: 0 0 auto;
        }
        
        /* REFUERZO DE COLORES Y DIVISIÓN EN ÍTEMS DEL TICKET */
        .ticket .items{
            max-height:46vh; 
            overflow:auto; 
            padding-right:0.25rem;
            margin-bottom: 10px; 
            padding-bottom: 5px;
        }
        
        .ticket .item{
            display:flex;
            gap:0.6rem;
            align-items:center;
            justify-content:space-between;
            padding:0.5rem; 
            margin-bottom: 8px; 
            border-radius: 6px;
            border-left: 5px solid rgba(0,0,0,0.1); 
            transition: border-left .3s ease;
        }

        .item.banderilla-salchicha { background-color: var(--color-salchicha) !important; border-left-color: var(--brand-dark) !important; }
        .item.banderilla-combinada { background-color: var(--color-combinada) !important; border-left-color: #007bff !important; }
        .item.banderilla-queso { background-color: var(--color-queso) !important; border-left-color: #28a745 !important; }
        .item.extra-item { background-color: var(--color-extra) !important; border-left-color: #777 !important; }
        
        /* Controles de cantidad/botones */
        .qty-controls { display: flex; gap: 4px; align-items: center; }
        
        /* ESTILO BOTONES +/- (Redondeados) */
        .qty-controls button {
            background:#ddd;
            border:none;
            border-radius:50%;
            width:28px;
            height:28px;
            font-weight:700;
            cursor:pointer;
            font-size: 1rem;
            padding: 0;
            line-height: 1;
        }

        /* ESTADO BOTÓN PREPARAR/LISTO */
        .done-btn { 
            border: none; 
            border-radius: 6px; 
            padding: 0.4rem 0.6rem; 
            font-weight: 600; 
            cursor: pointer; 
            white-space: nowrap; 
            transition: background .3s ease;
            background: var(--success); 
            color: #fff; 
        }
        .item:not(.done) .done-btn { 
            background: var(--accent); 
            color: #fff; 
        }
        
        /* Ajuste de márgenes en Totales */
        .totals{ 
            margin-top:0.9rem; 
            padding-bottom: 10px; 
            border-bottom: 1px solid #eee; 
            padding-left: 0; 
            padding-right: 0; 
        }
        /* AUMENTO DE ESPACIO ENTRE FILAS DE TOTALES */
        .totals .row {
            margin-bottom: 0.8rem; 
        }
        .totals .row:last-child {
            margin-bottom: 0; 
        }
        
        /* RESALTADO DE CANTIDAD PAGADA Y CAMBIO */
        #cash-paid-change-area {
            padding: 10px;
            border: 1px solid #ffcc80; 
            background: var(--highlight-cash); 
            border-radius: 8px;
            margin-top: 0.9rem;
            margin-bottom: 0.9rem;
        }

        /* AJUSTE PARA BOTÓN "GUARDAR TICKET" */
        .save-ticket-btn-container {
            display: flex;
            gap: 8px;
            margin-top: 0.9rem;
        }
        .save-ticket-btn-container .pay-btn {
            flex-grow: 1;
            padding: 0.85rem;
            border-radius: 12px;
            background: var(--brand);
            color: white;
            font-weight: 800;
            border: none;
            cursor: pointer;
            box-shadow: 0 10px 20px rgba(255,107,0,0.18);
            transition: transform .12s ease;
        }

        /* ALINEACIÓN Y DISEÑO DE CANTIDADES EN VENTAS POR PRODUCTO */
        #sales-summary-list .sale-item {
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            padding: 8px 12px; 
            margin-bottom: 6px; 
            border-radius: 6px;
            border-left: none; 
            border-bottom: 1px dashed rgba(0,0,0,0.1); 
            padding-bottom: 8px;
            padding-top: 8px;
        }
        
        /* ELIMINA BORDES y FONDO DE LA CANTIDAD EN EL RESUMEN DE VENTAS */
        .sale-item .qty {
            min-width: 30px; 
            text-align: right !important;
            display: block; 
            flex-shrink: 0; 
            padding: 0; 
            border: none !important; 
            background: none !important; 
            color: var(--brand-dark); 
            font-weight: 800;
        }
        .sale-item .name {
            flex-grow: 1;
            padding-right: 10px;
        }

        .sale-item.banderilla-salchicha { background-color: var(--color-salchicha); border-left-color: var(--brand-dark); }
        .sale-item.banderilla-combinada { background-color: var(--color-combinada); border-left-color: #007bff; }
        .sale-item.banderilla-queso { background-color: var(--color-queso); border-left-color: #28a745; }
        .sale-item.extra-item { background-color: var(--color-extra); border-left-color: #777; }
        
        /* REFUERZO DE DIVISIONES EN TICKETS GUARDADOS */
        #summary-list .summary-item {
            padding: 10px;
            background: var(--muted);
            border-radius: 8px;
            margin-bottom: 12px; 
            border-left: 5px solid var(--brand); 
            border-bottom: 2px solid rgba(0,0,0,0.1); 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); 
            cursor: pointer;
        }


        /* --- RESPONSIVIDAD MÓVIL (iPhone) --- */
        @media (max-width: 880px) {
            .wrap { grid-template-columns: 1fr; gap: 1rem; }
            .ticket-manager { order: 1; position: relative; top: 0; }
            .panel[aria-label="Productos"] { order: 2; }
            
            .product-grid { 
                grid-template-columns: repeat(3, 1fr); 
            }
            .prod:nth-child(2n){ border-right: 1px solid #eee; } 
            .prod:nth-child(3n) { border-right: none; } 
        }

        @media (max-width: 520px) {
            /* Se mantienen los estilos de compacidad anteriores */
            .totals .row { margin-bottom: 0.4rem; } 
        }

        /* --- ESTILOS DE IMPRESIÓN (PDF/Recibo) --- */
        @media print {
            body > .wrap > header,
            body > .wrap > .panel,
            body > .wrap > aside, 
            .footer-note {
                display: none !important;
            }
            
            @page {
                size: 80mm auto; 
                margin: 0;
            }

            #receipt-print-area {
                display: block !important;
                width: 300px; 
                margin: 0 auto;
                padding: 10px;
                background: white;
                font-family: monospace; 
                font-size: 10pt;
                color: #000;
            }
            
            .print-logo { text-align: center; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px dashed #000; }
            .print-logo .logo-box { width: 30px; height: 30px; border-radius: 5px; background: linear-gradient(135deg,var(--brand),var(--accent)); display: inline-flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 0.8rem; margin-right: 5px; }
            .print-header { font-size: 12pt; font-weight: bold; }
            .print-meta { font-size: 8pt; line-height: 1.2; margin-bottom: 10px; }
            .print-items { border-top: 1px dashed #000; padding-top: 5px; padding-bottom: 5px; margin-bottom: 5px; font-size: 9pt; }
            .print-item { display: flex; justify-content: space-between; line-height: 1.5; }
            .print-item-qty-name { flex-grow: 1; margin-right: 10px; }
            .print-item-total { width: 60px; text-align: right; }
            .print-totals { border-top: 1px dashed #000; padding-top: 5px; }
            .print-total-row { display: flex; justify-content: space-between; font-size: 10pt; font-weight: bold; }
            .print-final-total { font-size: 14pt !important; margin-top: 5px; }
            .print-note { border-top: 1px dashed #000; padding-top: 5px; margin-top: 5px; text-align: center; font-size: 8pt; }
        }
    </style>
</head>
<body style="display: none;"> <main class="wrap" role="main" aria-labelledby="title">
    <header class="app-header">
        <div class="brand">
            <div class="logo">AB</div>
            <div>
                <h1 id="title">Astro Bite</h1>
                <p class="sub">Caja rápida – Toma pedidos en segundos</p>
            </div>
        </div>
    </header>

    <aside class="ticket-manager" aria-label="Tickets Activos">
        <div class="ticket-tabs" id="ticket-tabs">
            <button class="new-ticket-btn" onclick="newTicket()">+</button> 
        </div>

        <div class="ticket" aria-label="Ticket Actual">
            <div style="display:flex; align-items:center; margin-bottom:0.6rem; border-bottom:1px solid #eee; padding-bottom:8px">
                <h2 style="margin:0; font-size:1.1rem; min-width:80px">Cliente:</h2>
                <input type="text" id="client-name-input" value="Sin Nombre" 
                    style="flex-grow:1; padding:0.5rem; border:1px solid #ddd; border-radius:6px; font-weight:700; font-size:1rem;" />
            </div>
            
            <div class="items" role="list" aria-live="polite"></div>

            <div class="totals" aria-hidden="false">
                <div class="row"><span>Subtotal</span><span id="subtotal">$0.00</span></div>
                <div class="row"><span>IVA (0%)</span><span>$0.00</span></div>
                <div class="row" style="font-size:1.1rem"><span>Total</span><span id="total">$0.00</span></div>
            </div>

            <div id="cash-paid-change-area">
                <div id="payment-cash-details" style="display:none;">
                    <label style="display:block;font-size:0.9rem;margin-bottom:0.3rem">Cantidad Pagada</label>
                    <input type="number" id="cash-paid-input" placeholder="0.00" step="any" min="0" 
                        style="width:100%;padding:0.55rem;border-radius:8px;border:1px solid #ddd; font-weight:700;" oninput="updateChange()">
                    <div class="row" style="margin-top:0.5rem"><span>Cambio</span><span id="cash-change">$0.00</span></div>
                </div>
            </div>

            <div style="margin-top:0.9rem">
                <label style="display:block;font-size:0.9rem;margin-bottom:0.3rem">Forma de Pago</label>
                <select id="payment-method-select" 
                    style="width:100%;padding:0.55rem;border-radius:8px;border:1px solid #eee" 
                    onchange="toggleCashDetails()">
                    <option value="Efectivo">Efectivo</option>
                    <option value="Tarjeta">Tarjeta</option>
                    <option value="Transferencia">Transferencia</option>
                </select>
            </div>
            
            <div style="margin-top:0.6rem">
                <label style="display:block;font-size:0.9rem;margin-bottom:0.3rem">Nota</label>
                <textarea id="ticket-note-input" placeholder="Ej: para llevar, sin sal" rows="2" style="width:100%;padding:0.55rem;border-radius:8px;border:1px solid #eee; resize:vertical;"></textarea>
            </div>
            
            <div class="save-ticket-btn-container">
                <button class="pay-btn" type="button" onclick="saveTicket()">Guardar ticket</button>
                <button class="pay-btn" type="button" onclick="prepareAndPrintReceipt()" style="flex-grow: 0; width: 44px; background: #007bff; font-size: 1.2rem;" title="Imprimir Recibo">⎙</button>
            </div>

        </div>
    </aside>

    <section class="panel" aria-label="Productos">
        <div id="product-panel-content">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.6rem">
                <h3 style="margin:0">Seleccionar producto</h3>
                <div class="muted">Toca para añadir</div>
            </div>

            <div class="categories" role="tablist" aria-label="Categorías">
                <button class="cat-btn active" data-cat="Salchicha">Salchicha</button>
                <button class="cat-btn" data-cat="Combinada">Combinada</button>
                <button class="cat-btn" data-cat="Queso">Queso</button>
                <button class="cat-btn" data-cat="Extras">Extras</button>
            </div>

            <div class="product-grid" id="product-grid" role="list"></div>
            <div class="extras" id="extras-grid"></div>
        </div>

        <section id="daily-summary" class="panel" style="margin-top: 1rem; padding: 1rem; display:none;">
            <h3 style="margin-top:0;">Resumen Diario (Tickets)</h3>
            
            <div id="read-only-ticket-container"></div>
            
            <div id="summary-list" style="max-height: 200px; overflow-y: auto;">
                <p class="muted center" id="summary-empty-message">No hay tickets guardados hoy.</p>
            </div>
        </section>

        <section id="sales-summary" class="panel" style="margin-top: 1rem; padding: 1rem; display:none;">
            <h3 style="margin-top:0;">Ventas por Producto (Total: <span id="daily-sales-total">$0.00</span>)</h3>
            
            <button onclick="resetAndExport()" 
                style="width: 100%; padding: 0.5rem; background: var(--danger); color: white; border: none; border-radius: 6px; margin-bottom: 10px; cursor: pointer; font-weight:700">
                Reiniciar Cuentas e Imprimir Informe (.xlsx)
            </button>

            <div id="sales-summary-list">
                <p class="muted center">No hay productos vendidos hoy.</p>
            </div>
        </section>
    </section>

    <div class="footer-note">Diseño rápido, listo para conectar a base de datos y *back-end*.</div>

    <div id="receipt-print-area" style="display:none;"></div>
</main>

<script>
// --- CÓDIGO DE BLOQUEO DE ACCESO (OPCIÓN BÁSICA) ---
const PASSWORD_CORRECTA = "123";

window.onload = function() {
    let intentos = 0;
    // La aplicación solo se inicia completamente después del intento de contraseña
    if (!localStorage.getItem('access_granted')) {
        while (intentos < 3) {
            const clave = prompt("Introduce tu contraseña para acceder al TPV:");
            if (clave === PASSWORD_CORRECTA) {
                localStorage.setItem('access_granted', 'true');
                document.body.style.display = 'flex'; // Muestra la aplicación
                break; 
            } else {
                intentos++;
                alert(`Contraseña incorrecta. Intentos restantes: ${3 - intentos}`);
            }
        }
        if (intentos >= 3) {
            document.body.innerHTML = '<main class="wrap" style="align-items:center; justify-content:center; height:100vh; grid-template-columns:1fr;"><h1 style="color: var(--danger);">❌ Acceso Denegado ❌</h1></main>';
            return;
        }
    } else {
        document.body.style.display = 'flex';
    }

    // El resto del código de inicialización se ejecuta aquí
    initializeTPV();
};

function initializeTPV() {
    loadAllData(); 
    if (activeTickets.length === 0) {
        newTicket('Cliente 1');
    } else {
        activeTicketIndex = activeTickets.length - 1; 
    }
    renderProducts("Salchicha"); 
    
    // Conexión de botones de categoría y resumen
    const categoriesContainer = document.querySelector('.categories');
    const summarySection = document.getElementById('daily-summary');
    const salesSection = document.getElementById('sales-summary'); 
    const productGridContainer = document.querySelector('.product-grid');
    const extrasGridContainer = document.querySelector('.extras');

    document.querySelectorAll('.cat-btn').forEach(btn=>{
        btn.addEventListener('click',()=>{
            document.querySelectorAll('.cat-btn').forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');
            const category = btn.dataset.cat;
            if (category) {
                summarySection.style.display = 'none';
                salesSection.style.display = 'none'; 
                readOnlyTicketContainerEl.style.display = 'none'; 
                
                if (category === 'Extras') {
                    productGridContainer.style.display = 'none';
                    extrasGridContainer.style.display = 'grid';
                } else {
                    productGridContainer.style.display = 'grid';
                    extrasGridContainer.style.display = 'none';
                }
                renderProducts(category);
            }
        });
    });

    const dailySummaryBtn = document.createElement('button');
    dailySummaryBtn.className = 'cat-btn';
    dailySummaryBtn.textContent = 'Tickets Guardados';
    dailySummaryBtn.dataset.cat = 'DailySummary';
    categoriesContainer.appendChild(dailySummaryBtn);

    dailySummaryBtn.addEventListener('click', () => {
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        dailySummaryBtn.classList.add('active');
        productGridContainer.style.display = 'none';
        extrasGridContainer.style.display = 'none';
        salesSection.style.display = 'none'; 
        summarySection.style.display = 'block';
        renderDailySummary();
    });

    const salesSummaryBtn = document.createElement('button');
    salesSummaryBtn.className = 'cat-btn';
    salesSummaryBtn.textContent = 'Ventas por Producto';
    salesSummaryBtn.dataset.cat = 'SalesSummary';
    categoriesContainer.appendChild(salesSummaryBtn);

    salesSummaryBtn.addEventListener('click', () => {
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        salesSummaryBtn.classList.add('active');
        productGridContainer.style.display = 'none';
        extrasGridContainer.style.display = 'none';
        summarySection.style.display = 'none'; 
        salesSection.style.display = 'block';
        renderSalesSummary();
    });

    document.querySelector('.cat-btn[data-cat="Salchicha"]').classList.add('active');
    renderTabs();
    renderTicket();
    toggleCashDetails(); 
}
// --- FIN CÓDIGO DE BLOQUEO Y INICIALIZACIÓN ---


const productsData = {
    Salchicha:[{name:"Ramen",price:45, relleno:"Salchicha"},{name:"Cruji",price:45, relleno:"Salchicha"},{name:"Papa",price:50, relleno:"Salchicha"},{name:"Cheetos",price:55, relleno:"Salchicha"},{name:"Flamin Hot",price:55, relleno:"Salchicha"}],
    Combinada:[{name:"Ramen",price:50, relleno:"Combinada"},{name:"Cruji",price:50, relleno:"Combinada"},{name:"Papa",price:55, relleno:"Combinada"},{name:"Cheetos",price:60, relleno:"Combinada"},{name:"Flamin Hot",price:60, relleno:"Combinada"}],
    Queso:[{name:"Ramen",price:55, relleno:"Queso"},{name:"Cruji",price:55, relleno:"Queso"},{name:"Papa",price:60, relleno:"Queso"},{name:"Cheetos",price:65, relleno:"Queso"},{name:"Flamin Hot",price:65, relleno:"Queso"}],
    Extras:[{name:"Órden de Papas",price:40, isExtra:true}, {name:"Salchipulpos",price:35, isExtra:true}]
};

// --- ARREGLOS DE DATOS y ELEMENTOS DOM ---
let activeTickets = []; 
let activeTicketIndex = -1; 
let dailySummaryTickets = []; 
let productSalesSummary = {}; 
let papasSalesSummary = 0; 

const ticketTabsEl = document.getElementById('ticket-tabs');
const clientNameInputEl = document.getElementById('client-name-input');
const ticketNoteInputEl = document.getElementById('ticket-note-input');
const paymentMethodSelectEl = document.getElementById('payment-method-select');
const productGrid=document.getElementById('product-grid');
const extrasGrid=document.getElementById('extras-grid');
const ticketItems=document.querySelector('.ticket .items');
const subtotalEl=document.getElementById('subtotal');
const totalEl=document.getElementById('total');
const summaryListEl = document.getElementById('summary-list');
const salesSummaryListEl = document.getElementById('sales-summary-list');
const dailySalesTotalEl = document.getElementById('daily-sales-total');
const cashPaidInputEl = document.getElementById('cash-paid-input');
const cashChangeEl = document.getElementById('cash-change');
const paymentCashDetailsEl = document.getElementById('payment-cash-details');
const readOnlyTicketContainerEl = document.getElementById('read-only-ticket-container');
const receiptPrintAreaEl = document.getElementById('receipt-print-area');


// --- PERSISTENCIA DE DATOS (sin cambios) ---
function saveAllData() {
    localStorage.setItem('dailySummaryTickets', JSON.stringify(dailySummaryTickets));
    localStorage.setItem('productSalesSummary', JSON.stringify(productSalesSummary));
    localStorage.setItem('papasSalesSummary', papasSalesSummary); 
}

function loadAllData() {
    const storedTickets = localStorage.getItem('dailySummaryTickets');
    if (storedTickets) { dailySummaryTickets = JSON.parse(storedTickets); }
    const storedSales = localStorage.getItem('productSalesSummary');
    if (storedSales) { productSalesSummary = JSON.parse(storedSales); }
    const storedPapas = localStorage.getItem('papasSalesSummary');
    if (storedPapas) { papasSalesSummary = parseInt(storedPapas) || 0; }
}

// --- LÓGICA DE PAGO ---

function toggleCashDetails() {
    const isEfectivo = paymentMethodSelectEl.value === 'Efectivo';
    paymentCashDetailsEl.style.display = isEfectivo ? 'block' : 'none';
    
    const cashArea = document.getElementById('cash-paid-change-area');
    if (isEfectivo) {
        cashArea.style.padding = '10px';
        cashArea.style.border = '1px solid #ffcc80';
        cashArea.style.background = 'var(--highlight-cash)';
    } else {
        cashArea.style.padding = '0';
        cashArea.style.border = 'none';
        cashArea.style.background = 'none';
    }

    if (!isEfectivo) {
        cashPaidInputEl.value = '';
        cashChangeEl.textContent = '$0.00';
    } else {
        updateChange();
    }
}

function updateChange() {
    const total = parseFloat(totalEl.textContent.replace('$', '')) || 0;
    const paid = parseFloat(cashPaidInputEl.value) || 0;
    const change = Math.max(0, paid - total);
    cashChangeEl.textContent = `$${change.toFixed(2)}`;
}

// --- GESTIÓN DE TICKETS ---

function newTicket(defaultName) {
    const finalName = defaultName || `Cliente ${activeTickets.length + 1}`; 
    const newTicket = {
        id: Date.now(),
        name: finalName,
        items: [],
        note: '',
        paymentMethod: 'Efectivo',
        paid: 0, 
        change: 0 
    };
    activeTickets.push(newTicket);
    activeTicketIndex = activeTickets.length - 1; 
    renderTabs();
    renderTicket();
    toggleCashDetails();
    readOnlyTicketContainerEl.style.display = 'none'; 
}

function selectTicket(index) {
    activeTicketIndex = index;
    renderTabs();
    renderTicket();
    toggleCashDetails();
    readOnlyTicketContainerEl.style.display = 'none'; 
}

function removeTicket(index, isSave = false) {
    if (!isSave && !confirm(`¿Estás seguro de que quieres eliminar el ticket de "${activeTickets[index].name}"?`)) {
        return;
    }
    activeTickets.splice(index, 1);
    saveAllData(); 
    if (activeTickets.length === 0) {
        activeTicketIndex = -1;
        newTicket('Cliente 1'); 
    } else {
        if (index === activeTicketIndex) {
            activeTicketIndex = Math.max(0, activeTickets.length - 1);
        } else if (index < activeTicketIndex) {
            activeTicketIndex--; 
        }
        renderTabs();
        renderTicket();
    }
}

function saveTicket() {
    if (activeTicketIndex === -1) return alert("No hay ticket activo para guardar.");
    const currentTicket = activeTickets[activeTicketIndex];
    if (currentTicket.items.length === 0) {
        alert(`El ticket de "${currentTicket.name}" está vacío. No se guardará.`);
        removeTicket(activeTicketIndex);
        return;
    }

    const total = calculateTotal(currentTicket.items);
    
    currentTicket.paymentMethod = paymentMethodSelectEl.value;
    currentTicket.paid = parseFloat(cashPaidInputEl.value) || (currentTicket.paymentMethod !== 'Efectivo' ? total : 0);
    currentTicket.change = parseFloat(cashChangeEl.textContent.replace('$', '')) || 0;

    if (currentTicket.paymentMethod === 'Efectivo' && currentTicket.paid < total) {
        return alert("Error: La cantidad pagada en efectivo es insuficiente.");
    }

    currentTicket.items.forEach(item => {
        const { key } = createProductKey(item);
        productSalesSummary[key] = (productSalesSummary[key] || 0) + item.qty;
        if (item.papas || (item.papasExtra && item.name !== 'Órden de Papas')) {
            papasSalesSummary += item.qty;
        }
    });
    renderSalesSummary();

    const ticketToSave = { 
        ...currentTicket, 
        total: total, 
        date: new Date().toLocaleString()
    };
    dailySummaryTickets.push(ticketToSave);
    renderDailySummary(); 
    alert(`Ticket de "${currentTicket.name}" guardado. Total: $${total.toFixed(2)}. Cambio: $${currentTicket.change.toFixed(2)}. (Simulación de cierre de venta)`);
    saveAllData(); 
    removeTicket(activeTicketIndex, true); 
}

function renderTabs() {
    const tabsContainer = ticketTabsEl;
    const tabsToRemove = tabsContainer.querySelectorAll('.ticket-tab');
    tabsToRemove.forEach(tab => tab.remove());
    
    activeTickets.forEach((t, i) => {
        const tab = document.createElement('button');
        const firstItem = t.items.find(item => !item.isExtra);
        let tabColorClass = '';
        if (firstItem) {
            tabColorClass = `banderilla-${firstItem.relleno.toLowerCase()}`;
        }
        tab.className = `ticket-tab ${i === activeTicketIndex ? 'active' : ''} ${tabColorClass}`;
        tab.setAttribute('data-index', i);
        tab.onclick = () => selectTicket(i);
        tab.innerHTML = `<span>${t.name} (${t.items.length})</span>`; 
        const closeBtn = document.createElement('button');
        closeBtn.className = 'close-tab';
        closeBtn.innerHTML = '×'; 
        closeBtn.onclick = (e) => {
            e.stopPropagation(); 
            removeTicket(i);
        };
        tab.appendChild(closeBtn);
        ticketTabsEl.insertBefore(tab, ticketTabsEl.querySelector('.new-ticket-btn'));
    });
}

// --- LÓGICA DE PRODUCTOS y RENDERIZADO ---
function createProductKey(item) {
    let key = item.name;
    let relleno = item.relleno;
    if (relleno) {
        key = `${relleno} ${item.name}`;
    } else {
        relleno = 'extra';
    }
    return { key, relleno: relleno.toLowerCase() };
}

function calculateTotal(items) {
    let subtotal = 0;
    items.forEach(item => {
        let price = item.price;
        if (item.papas) price += 15;
        if (item.papasExtra) price += 15; 
        subtotal += price * item.qty;
    });
    return subtotal;
}

function changeQuantity(itemIndex, delta) {
    const ticket = activeTickets[activeTicketIndex];
    const item = ticket.items[itemIndex];
    item.qty += delta;
    if (item.qty <= 0) { removeItem(itemIndex); } else { renderTicket(); renderTabs(); }
}

function removeItem(itemIndex){ 
    const ticket = activeTickets[activeTicketIndex];
    ticket.items.splice(itemIndex,1);
    renderTabs(); 
    renderTicket();
}

function togglePapas(itemIndex){
    const ticket = activeTickets[activeTicketIndex];
    ticket.items[itemIndex].papas=!ticket.items[itemIndex].papas;
    renderTicket();
}

function togglePapasExtra(itemIndex){
    const ticket = activeTickets[activeTicketIndex];
    ticket.items[itemIndex].papasExtra = !ticket.items[itemIndex].papasExtra;
    renderTicket();
}

function toggleDone(itemIndex){
    const ticket = activeTickets[activeTicketIndex];
    ticket.items[itemIndex].done = !ticket.items[itemIndex].done;
    renderTicket();
}

function renderProducts(category){
    productGrid.innerHTML="";
    extrasGrid.innerHTML="";
    
    if(category==="Extras"){
        productsData.Extras.forEach(p=>{
            const btn=document.createElement("button");
            btn.className="ext-btn";
            btn.innerHTML=`<div class="name">${p.name}</div><div class="price">$${p.price}</div>`;
            btn.onclick=()=>addToTicket({...p,qty:1});
            extrasGrid.appendChild(btn);
        });
        return;
    }
    productsData[category].forEach(p=>{
        const div=document.createElement("div");
        div.className="prod";
        div.innerHTML=`<div class="name">${p.name}</div><div class="price">$${p.price}</div>`;
        div.onclick=()=>addToTicket({...p,qty:1,papas:false, relleno: p.relleno, done:false}); 
        productGrid.appendChild(div);
    });
}

function addToTicket(item){
    if (activeTicketIndex === -1) {
        newTicket('Cliente 1'); 
        if (activeTickets.length === 0) return; 
    }
    const ticket = activeTickets[activeTicketIndex];
    const itemToAdd = item.isExtra 
        ? {...item, id: Date.now(), qty:1, isExtra:true, papasExtra: item.name === 'Salchipulpos' ? false : undefined, done:false}
        : {...item, id: Date.now(), qty:1, isExtra:false, papas:false, relleno: item.relleno, done:false};
    if (itemToAdd.name === 'Órden de Papas') { delete itemToAdd.papasExtra; }
    ticket.items.push(itemToAdd);
    renderTabs(); 
    renderTicket();
}


function renderTicket(){
    if (activeTicketIndex === -1 || activeTickets.length === 0) {
        // [Estado sin tickets]
        ticketItems.innerHTML='<div class="empty">Crea un nuevo ticket para empezar a tomar pedidos.</div>';
        clientNameInputEl.value = "Sin Tickets Activos";
        clientNameInputEl.disabled = true; 
        subtotalEl.textContent=`$0.00`;
        totalEl.textContent=`$0.00`;
        ticketNoteInputEl.value = '';
        paymentMethodSelectEl.value = 'Efectivo';
        cashPaidInputEl.value = '';
        cashChangeEl.textContent = '$0.00';
        toggleCashDetails(); 
        return;
    }
    
    const currentTicket = activeTickets[activeTicketIndex];
    clientNameInputEl.value = currentTicket.name;
    clientNameInputEl.disabled = false;
    ticketNoteInputEl.value = currentTicket.note;
    paymentMethodSelectEl.value = currentTicket.paymentMethod;

    clientNameInputEl.oninput = (e) => { currentTicket.name = e.target.value; renderTabs(); };
    ticketNoteInputEl.oninput = (e) => { currentTicket.note = e.target.value; };

    cashPaidInputEl.value = currentTicket.paid || ''; 

    // Renderizar ítems
    ticketItems.innerHTML="";
    if(currentTicket.items.length===0){
        ticketItems.innerHTML='<div class="empty">No hay productos en el ticket. Añade desde la izquierda.</div>';
    }

    let subtotal=0;
    currentTicket.items.forEach((item,i)=>{
        let price=item.price;
        if(item.papas) price+=15;
        if(item.papasExtra) price+=15;
        subtotal+=price*item.qty;

        const qtyControls = `<div class="qty-controls"><button onclick="changeQuantity(${i}, -1)">–</button><div class="qty">${item.qty}</div><button onclick="changeQuantity(${i}, 1)">+</button></div>`;
        const removeButton = `<button onclick="removeItem(${i})" style="background:none;border:none;color:var(--danger);cursor:pointer;font-weight:800;font-size:1.2rem; margin-left: 4px;">&times;</button>`;
        const priceDisplay = `<div style="font-weight:800; min-width:65px; text-align:right">$${(price*item.qty).toFixed(2)}</div>`;
        const papasCheckbox = (!item.isExtra && item.name !== 'Órden de Papas') ? `<label style="margin-left:8px;font-size:0.85rem;white-space:nowrap; cursor:pointer;"><input type="checkbox" ${item.papas?"checked":""} onchange="togglePapas(${i})"> Papas +$15</label>` : '';
        const metaContent=`<div class="main-name">${item.relleno || item.name}</div><div class="small muted">${item.isExtra ? 'Extra' : item.name}</div>${papasCheckbox}`;
        
        const div=document.createElement('div');
        div.className=`item ${item.relleno ? 'banderilla-' + item.relleno.toLowerCase() : 'extra-item'} ${item.done ? 'done' : ''}`;
        
        // REFUERZO VISUAL DEL BOTÓN PREPARAR/LISTO
        const doneBtnClass = item.done ? 'done-btn' : 'done-btn preparing';
        const doneButtonHtml = `<button class="${doneBtnClass}" onclick="toggleDone(${i})">${item.done ? 'Listo' : 'Preparar'}</button>`;


        div.innerHTML=`<div class="meta">${metaContent}</div><div style="display:flex;gap:4px;align-items:center">${doneButtonHtml}${qtyControls}${priceDisplay}${removeButton}</div>`;
        ticketItems.appendChild(div);
    });
    
    const total = calculateTotal(currentTicket.items);
    subtotalEl.textContent=`$${subtotal.toFixed(2)}`;
    totalEl.textContent=`$${total.toFixed(2)}`;
    
    updateChange();
    renderTabs(); 
}


// --- LECTURA DE TICKETS GUARDADOS ---

function displayReadOnlyTicket(ticket) {
    const total = ticket.total.toFixed(2);
    const paid = (ticket.paid || 0).toFixed(2);
    const change = (ticket.change || 0).toFixed(2);
    
    let itemsHtml = ticket.items.map(item => {
        let name = item.name;
        if (item.relleno) name = `${item.relleno} ${item.name}`;
        if (item.papas) name += ' (+Papas)';
        if (item.papasExtra) name += ' (+Papas)';
        
        const price = item.price + (item.papas ? 15 : 0) + (item.papasExtra ? 15 : 0);
        const itemTotal = (price * item.qty).toFixed(2);
        
        return `<div class="ro-item">
                    <span class="ro-item-name">${item.qty} x ${name}</span>
                    <span>$${itemTotal}</span>
                </div>`;
    }).join('');

    readOnlyTicketContainerEl.innerHTML = `
        <div id="read-only-ticket-view">
            <div class="ro-title">Ticket Guardado</div>
            
            <div class="ro-row"><span>Cliente:</span><span>${ticket.name}</span></div>
            <div class="ro-row"><span>Hora:</span><span>${new Date(ticket.id).toLocaleTimeString()}</span></div>
            <div class="ro-row"><span>Forma de Pago:</span><span>${ticket.paymentMethod}</span></div>
            ${ticket.note ? `<div class="ro-row" style="flex-direction: column; margin-top: 5px;"><span>Nota:</span><span style="font-weight: 400; font-size: 0.9rem;">${ticket.note}</span></div>` : ''}

            <div class="ro-items">${itemsHtml}</div>
            
            <div class="ro-row"><span>Total:</span><span style="font-size: 1.2rem; color: var(--brand-dark);">$${total}</span></div>
            <div class="ro-row"><span>Pagado:</span><span>$${paid}</span></div>
            <div class="ro-row" style="border-top: 1px dashed #ccc; margin-top: 5px;"><span>Cambio:</span><span>$${change}</span></div>
            
            <button class="pay-btn ro-print-btn" style="background: #007bff; margin-top: 15px;" 
                    onclick="prepareAndPrintReceipt(dailySummaryTickets.find(t => t.id === ${ticket.id}))">
                Imprimir Recibo (PDF) ⎙
            </button>
        </div>
    `;
    readOnlyTicketContainerEl.style.display = 'block';
}

function reopenTicket(ticketId) {
    const ticket = dailySummaryTickets.find(t => t.id === ticketId);
    if (ticket) {
        summaryListEl.style.display = 'none';
        displayReadOnlyTicket(ticket);
    }
}

function renderDailySummary() {
    readOnlyTicketContainerEl.style.display = 'none'; 
    summaryListEl.style.display = 'block';

    if (dailySummaryTickets.length === 0) {
        summaryListEl.innerHTML = '<p class="muted center">No hay tickets guardados hoy.</p>';
    } else {
        summaryListEl.innerHTML = '';
        [...dailySummaryTickets].reverse().forEach(ticket => { 
            const div = document.createElement('div');
            div.className = 'summary-item';
            div.onclick = () => reopenTicket(ticket.id); 

            const itemsList = ticket.items.map(item => {
                let name = item.name;
                if (item.relleno) name = `${item.relleno} ${item.name}`;
                if (item.papas || item.papasExtra) name += ' + Papas';
                return `${item.qty} ${name}`;
            }).join('; ');

            div.innerHTML = `
                <h4>
                    <span>${ticket.name}</span>
                    <span style="color:var(--brand-dark);">$${ticket.total.toFixed(2)}</span>
                </h4>
                <div class="details">
                    <span>Pago:</span> ${ticket.paymentMethod} | 
                    <span>Items:</span> ${itemsList}
                </div>
            `;
            summaryListEl.appendChild(div);
        });
    }
    renderSalesSummary();
}


// --- PREPARACIÓN DE PDF ---

function prepareAndPrintReceipt(ticket = null) {
    if (!ticket) {
        if (activeTicketIndex === -1) {
            alert("No hay un ticket activo para imprimir.");
            return;
        }
        // Tomar datos del ticket activo y re-calcular el pago y cambio
        ticket = activeTickets[activeTicketIndex];
        ticket.date = new Date().toLocaleString(); 
        ticket.paid = parseFloat(cashPaidInputEl.value) || (ticket.paymentMethod !== 'Efectivo' ? parseFloat(totalEl.textContent.replace('$', '')) : 0);
        ticket.change = parseFloat(cashChangeEl.textContent.replace('$', '')) || 0;
        ticket.total = parseFloat(totalEl.textContent.replace('$', '')) || 0;
    }
    
    receiptPrintAreaEl.innerHTML = ''; 

    const dateObj = new Date(ticket.date);
    let dateStr = dateObj.toLocaleDateString();
    let timeStr = dateObj.toLocaleTimeString();

    // Comprobación de que la fecha se está generando
    if (isNaN(dateObj)) {
        console.error("Error al parsear la fecha:", ticket.date);
        const now = new Date();
        dateStr = now.toLocaleDateString();
        timeStr = now.toLocaleTimeString();
    }


    let receiptHtml = `
        <div class="print-logo">
            <div class="logo-box">AB</div>
            <span class="print-header">ASTRO BITE</span>
            <p>¡Gracias por tu compra!</p>
        </div>
        <div class="print-meta">
            <p>Fecha/Hora: ${dateStr} ${timeStr}</p>
            <p>Cliente: ${ticket.name}</p>
        </div>
        <div class="print-items">
    `;

    ticket.items.forEach(item => {
        let name = item.name;
        if (item.relleno) name = `${item.relleno} ${item.name}`;
        if (item.papas) name += ' (+Papas)';
        if (item.papasExtra) name += ' (+Papas)';

        const price = item.price + (item.papas ? 15 : 0) + (item.papasExtra ? 15 : 0);
        const itemTotal = (price * item.qty).toFixed(2);
        
        receiptHtml += `
            <div class="print-item">
                <span class="print-item-qty-name">${item.qty} x ${name}</span>
                <span class="print-item-total">$${itemTotal}</span>
            </div>
        `;
    });
    
    receiptHtml += `</div>`;
    
    receiptHtml += `
        <div class="print-totals">
            <div class="print-total-row"><span>TOTAL:</span><span class="print-final-total">$${ticket.total.toFixed(2)}</span></div>
            <div class="print-total-row"><span>Método:</span><span>${ticket.paymentMethod}</span></div>
            <div class="print-total-row"><span>PAGO:</span><span>$${(ticket.paid).toFixed(2)}</span></div>
            <div class="print-total-row"><span>CAMBIO:</span><span>$${(ticket.change).toFixed(2)}</span></div>
        </div>
        <div class="print-note">
            ${ticket.note ? `<p>Nota: ${ticket.note}</p>` : ''}
            <p>¡Vuelve pronto!</p>
        </div>
    `;

    receiptPrintAreaEl.innerHTML = receiptHtml;

    // USO DE setTimeout para asegurar que el DOM se actualice antes de imprimir
    setTimeout(() => {
        window.print();
    }, 100);
}


// --- Resto de funciones (sin cambios funcionales) ---
function renderSalesSummary() {
    const detailedSales = {};
    Object.entries(productSalesSummary).forEach(([fullKey, qty]) => {
        let relleno = 'extra';
        if (fullKey.includes('Salchicha')) { relleno = 'salchicha'; }
        else if (fullKey.includes('Combinada')) { relleno = 'combinada'; }
        else if (fullKey.includes('Queso')) { relleno = 'queso'; }
        detailedSales[fullKey] = { name: fullKey, qty: qty, relleno: relleno };
    });
    const keys = Object.keys(detailedSales);
    if (papasSalesSummary > 0) {
        const papasKey = "Papas Adicionales ($15)";
        detailedSales[papasKey] = { name: papasKey, qty: papasSalesSummary, relleno: 'extra' };
        if (!keys.includes(papasKey)) { keys.push(papasKey); }
    }
    if (keys.length === 0) {
        salesSummaryListEl.innerHTML = '<p class="muted center">No hay productos vendidos hoy.</p>';
    } else {
        salesSummaryListEl.innerHTML = '';
        keys.sort((a, b) => detailedSales[b].qty - detailedSales[a].qty);
        keys.forEach(key => {
            const item = detailedSales[key];
            const div = document.createElement('div');
            div.className = `sale-item banderilla-${item.relleno}`; 
            div.innerHTML = `<div class="name">${item.name}</div><div class="qty">${item.qty}</div>`;
            salesSummaryListEl.appendChild(div);
        });
    }
    const grandTotal = dailySummaryTickets.reduce((sum, ticket) => sum + ticket.total, 0);
    dailySalesTotalEl.textContent = `$${grandTotal.toFixed(2)}`;
}

function exportToXLSX() {
    if (dailySummaryTickets.length === 0 && Object.keys(productSalesSummary).length === 0) { return false; }

    const transactionsData = [];
    const headersTransacciones = ["ID Transaccion", "Cliente", "Hora de Compra", "Forma de Pago", "Items Comprados", "Monto Total"];
    transactionsData.push(headersTransacciones);

    dailySummaryTickets.forEach(ticket => {
        const time = new Date(ticket.id).toLocaleTimeString();
        const items = ticket.items.map(item => {
            let name = item.name;
            if (item.relleno) name = `${item.relleno} ${item.name}`;
            if (item.papas || item.papasExtra) name += ' c/Papas';
            return `${item.qty}x ${name}`.replace(/"/g, '').replace(/,/g, ' '); 
        }).join(' | ');

        transactionsData.push([
            ticket.id,
            ticket.name,
            time,
            ticket.paymentMethod,
            items,
            parseFloat(ticket.total.toFixed(2)) 
        ]);
    });
    
    const salesData = [];
    const headersKPIs = ["Producto/Variante", "Cantidad Vendida"];
    salesData.push(headersKPIs);

    const keys = Object.keys(productSalesSummary).sort(); 
    keys.forEach(key => {
        salesData.push([key, productSalesSummary[key]]);
    });

    if (papasSalesSummary > 0) {
        salesData.push(["Papas Adicionales ($15)", papasSalesSummary]);
    }
    
    const grandTotal = dailySummaryTickets.reduce((sum, ticket) => sum + ticket.total, 0);
    salesData.push(["", ""]); 
    salesData.push(["TOTAL VENTA GENERAL", parseFloat(grandTotal.toFixed(2))]);

    const wb = XLSX.utils.book_new();

    const ws1 = XLSX.utils.aoa_to_sheet(transactionsData);
    ws1['!cols'] = [
        {wch: 15}, {wch: 20}, {wch: 15}, {wch: 15}, {wch: 50}, {wch: 15}
    ];
    for(let i = 1; i < transactionsData.length; i++) {
        const cellRef = XLSX.utils.encode_cell({r: i, c: 5}); 
        if (ws1[cellRef]) ws1[cellRef].z = "$0.00";
    }
    XLSX.utils.book_append_sheet(wb, ws1, "Transacciones Detalle");


    const ws2 = XLSX.utils.aoa_to_sheet(salesData);
    ws2['!cols'] = [
        {wch: 45}, {wch: 18}
    ];
    const totalRowIndex = salesData.length - 1;
    const totalCellRef = XLSX.utils.encode_cell({r: totalRowIndex, c: 1}); 
    if (ws2[totalCellRef]) ws2[totalCellRef].z = "$0.00";
    
    XLSX.utils.book_append_sheet(wb, ws2, "Inventario y KPIs");

    const dateStr = new Date().toISOString().slice(0, 10);
    XLSX.writeFile(wb, `Informe_AstroBite_${dateStr}.xlsx`);
    
    return true; 
}

function resetAndExport() {
    if (!confirm("ADVERTENCIA: ¿Estás seguro de REINICIAR LAS CUENTAS DIARIAS? Esto borrará el resumen de ventas. ¡Asegúrate de EXPORTAR!")) { return; }
    const success = exportToXLSX();
    if (success) {
        dailySummaryTickets = [];
        productSalesSummary = {};
        papasSalesSummary = 0;
        saveAllData(); 
        renderDailySummary(); 
        renderSalesSummary();
        alert("Cuentas reiniciadas a cero. El informe XLSX se ha descargado.");
    } else {
        alert("El reinicio fue cancelado porque no hay datos de ventas para exportar.");
    }
}


// --- INICIALIZACIÓN ---
document.addEventListener('DOMContentLoaded', (event) => {
    // La inicialización se movió a window.onload para respetar el bloqueo de contraseña
});
</script>

</body>
</html>